<!--
@license https://github.com/t2ym/i18n-behavior/blob/master/LICENSE.md
Copyright (c) 2016, Tetsuya Mori <t2y3141592@gmail.com>. All rights reserved.
--><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script>
/*!
 * @license https://github.com/t2ym/i18n-behavior/blob/master/LICENSE.md
 * Copyright (c) 2016, Tetsuya Mori <t2y3141592@gmail.com>. All rights reserved.
 */
    </script>

    <script src="../../../webcomponentsjs/webcomponents-lite.min.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="test-runner.js"></script>

    <link rel="import" href="../../../promise-polyfill/promise-polyfill-lite.html">
    <link rel="import" href="../../i18n-behavior.html">
    <link rel="import" href="preference/preference-element.html">
    <style>
    .test-container.running-test {
      display: block;
    }
    .test-container:not(.running-test) { 
      display: none;
    }
    </style>
  </head>
  <body>
    <h2 id="test-name"></h2>

    <div class="test-container" id="persist">
    </div>

    <script>
suite('I18nBehavior with ' + 
  (window.location.href.indexOf('?dom=Shadow') >= 0 ? 'Shadow DOM' : 'Shady DOM'), 
  function () {

  var lang0 = '';
  var lang1 = 'en';
  var lang2 = 'fr';
  var lang3 = 'ja';
  var lang4 = 'fr-CA';
  var lang5 = 'zh-Hans-CN';
  var lang6 = 'ru';
  var lang7 = 'zh-yue-Hans-CN';
  var lang8 = 'zh-CN';
  var lang9 = 'zh-TW';
  var lang10 = 'zh-Hans-CN-x-Linux';
  var navigatorLanguage = navigator.language;
  var isNavigatorLanguageEn = navigator.language.match(/^en/);
  var html = document.querySelector('html');
  var persist;
  var preference;

  var suites = [
    s('preference', null, {
      fixture: 'preference-element-fixture', 
      fixtureModel: undefined,
      assign: undefined,
      lang: isNavigatorLanguageEn ? lang1 : lang0,
      effectiveLang: isNavigatorLanguageEn ? lang1 : lang0,
      templateDefaultLang: lang1,
      observeHtmlLang: true,
      event: 'local-dom-ready',
      text: { model: {} },
      model: {},
      localDOM: [
        { select: 'span#oldLang', 'lang.raw': navigatorLanguage }
      ],
      lightDOM: undefined
    })
  ];

  //suitesRunner(suites);

  suite('preference', function () {
    setup(function () {
      persist = document.querySelector('#persist');
      delete window.localStorage['i18n-behavior-preference'];
      preference = Polymer.Base.create('i18n-preference', { persist: true });
      persist.appendChild(preference);
      return new Promise(function (resolve, reject) {
        persist.addEventListener('iron-localstorage-load-empty', function persistSetup (e) {
          persist.removeEventListener('iron-localstorage-load-empty', persistSetup);
          console.log('iron-localstorage-load-empty');
          resolve();
        });
      });
    });

    test('change lang', function (done) {
      html.lang = lang10;
      var intervalId = window.setTimeout(function () {
        if (JSON.parse(window.localStorage['i18n-behavior-preference']) === lang10) {
          assert.equal(JSON.parse(window.localStorage['i18n-behavior-preference']), lang10, 'localStorage is ' + lang10);
          window.clearInterval(intervalId);
          done();
        }
      }, 100);
    });

  });

  suite('preference 2', function () {
    setup(function () {
      persist = document.querySelector('#persist');
      delete window.localStorage['i18n-behavior-preference'];
      window.localStorage['i18n-behavior-preference'] = JSON.stringify(lang3);
      preference = Polymer.Base.create('i18n-preference', { persist: true });
      persist.appendChild(preference);
      return new Promise(function (resolve, reject) {
        persist.addEventListener('iron-localstorage-load', function persistSetup (e) {
          persist.removeEventListener('iron-localstorage-load', persistSetup);
          console.log('iron-localstorage-load');
          resolve();
        });
      });
    });

    test('change lang', function (done) {
      html.lang = lang10;
      var intervalId = window.setTimeout(function () {
        if (JSON.parse(window.localStorage['i18n-behavior-preference']) === lang10) {
          assert.equal(JSON.parse(window.localStorage['i18n-behavior-preference']), lang10, 'localStorage is ' + lang10);
          window.clearInterval(intervalId);
          done();
        }
      }, 100);
    });

    test('change persist', function (done) {
      preference.persist = false;
      var intervalId = window.setTimeout(function () {
        if (window.localStorage['i18n-behavior-preference'] === undefined) {
          assert.equal(window.localStorage['i18n-behavior-preference'], undefined, 'localStorage is ' + undefined);
          window.clearInterval(intervalId);
          done();
        }
      }, 100);
    });

    test('detach', function (done) {
      persist.removeChild(preference);
      persist.appendChild(preference);
      assert.ok(preference, 'preference is attached');
      done();
    });
  });

});
    </script>

  

</body></html>