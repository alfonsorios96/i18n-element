<!--
@license https://github.com/t2ym/i18n-element/blob/master/LICENSE.md
Copyright (c) 2016, Tetsuya Mori <t2y3141592@gmail.com>. All rights reserved.
-->
<html debug>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>i18n-element Proof of Concept Demo</title>
    <script>
    window.addEventListener("error", function (e) {
      console.log("Error occured: " + e.error.message);
      e.stopPropagation();
      return false;
    });
    console.log('this = ', this);
    </script>
    <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
<script>
(function () {
  function UncamelCase (name) {
    return name
      // insert a hyphen between lower & upper
      .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
      // space before last upper in a sequence followed by lower
      .replace(/\b([A-Z]+)([A-Z])([a-z0-9])/, '$1 $2$3')
      // replace spaces with hyphens
      .replace(/ /g, '-')
      // lowercase
      .toLowerCase();
  }
  function functionName (func) {
    return typeof func === 'function' ? 
            func.toString().replace(/^[\S\s]*?function\s*/, "").replace(/[\s\(\/][\S\s]+$/, "") :
            undefined;
  }
  if (!window.Define) {
    Object.defineProperty(window, 'Define', {
      get: function () {
        return function (id) {
          return this.PolymerElements ? this.PolymerElements[id] : undefined;
        };
      },
      set: function (proto) {
        /*
        Patterns:
          a) template id {}
          b) template id {is}
          c) document.template id {is}
          d) template {is}
          e) {is}
          f) class Is {template}
          g) {is,template}
        */
        var id;
        var classId;
        var obj;
        var name = proto.name || functionName(proto);
        var current; // currentScript
        var template = null;
        var previous; // previousSibling template
        var cousin; // dom5.serialize output support

        current = HTMLImports.useNative ? document.currentScript
                                        : document._currentScript;

        previous = current.previousSibling;
        while (previous && !previous.tagName) {
          previous = previous.previousSibling;
        }
        if (previous && previous.tagName !== 'template'.toUpperCase()) {
          previous = null;
        }
        if (!previous) {
          // search for cousin template
          if (current.parentNode.tagName === 'body'.toUpperCase()) {
            previous = current.parentNode.previousSibling;
            while (previous && !previous.tagName) {
              previous = previous.previousSibling;
            }
            if (previous && previous.tagName.toLowerCase() === 'head') {
              for (var i = 0; i < previous.childNodes.length; i++) {
                if (previous.childNodes[i].tagName === 'template'.toUpperCase()) {
                  cousin = previous.childNodes[i];
                  break;
                }
              }
            }
          }
          if (cousin) {
            previous = cousin;
          }
          else {
            previous = null;
          }
        }

        if (!proto.is && (!name || name === 'class' || name === 'Define')) {
          if (previous) {
            id = previous.id;
            if (id) {
              // Pattern a)
              template = previous;
              proto.is = id;
            }
          }
        }
        else {
          if (proto.is) {
            id = proto.is;
          }
          else if (typeof proto === 'function' && name) {
            // ES6 class
            id = UncamelCase(name);
            classId = name;
          }
          if (!template && proto.template && !name) {
            // Pattern g)
            template = proto.template;
          }
          if (!proto.template && !template) {
            // Pattern b), c)
            template = current.ownerDocument
                        .querySelector('template[id=' + id + ']') || 
                       document.querySelector('template[id=' + id + ']');
          }
          if (!proto.template && !template && previous && !previous.id) {
            // Pattern d)
            template = previous;
            template.id = id;
          }
          else {
            // Pattern e)
          }
        }

        if (!id) {
          throw 'Custom element name is not defined';
        }

        // register dom-module
        if (template) {
          var domModule = document.createElement('dom-module');
          var assetUrl = new URL(current.baseURI || window.currentImport.baseURI);
          domModule.appendChild(template);
          domModule.setAttribute('assetpath', 
                                  assetUrl.pathname.indexOf('.vulcanized.') < 0 ?
                                    assetUrl.pathname :
                                      template.hasAttribute('assetpath') ? 
                                      template.getAttribute('assetpath') : 
                                      assetUrl.pathname);
          domModule.register(id);
        }

        // register Custom Element
        this.PolymerElements = this.PolymerElements || {};
        classId = classId || id.split('-').map(function (word) {
          return word[0].toUpperCase() + word.substr(1);
        }).join('');
        if (this.PolymerElements[id]) {
          console.warn('Discarding duplicate regitration of custom element ' + id);
        }
        else {
          window[classId] = proto;
          customElements.define(id, proto);
          this.PolymerElements[classId] = this.PolymerElements[id];
        }
        return this.PolymerElements[id];
      }
    });
  }
})();
</script>
    <script>
    window.document._querySelector = new Proxy(window.document.querySelector, {
      apply: function querySelector (target, thisArg, argumentsList) {
        console.log(target, thisArg, argumentsList);
        return target.apply(thisArg, argumentsList);
      },
      get: function(target, prop, receiver) {
        console.log('document.querySelector' + prop);
        return target[prop];
      }
    });
    /*
    HTMLElement.prototype.constructor = new Proxy(HTMLElement.prototype.constructor, { 
      apply: function(target, thisArg, argumentsList) {
        console.log('HTMLElement.prototype.constructor', target, thisArg, argumentsList);
        return target.apply(thisArg, argumentsList);        
      }
    });
    */
    Object.getPrototypeOf(window.customElements).define = new Proxy(Object.getPrototypeOf(window.customElements).define, {
      apply: function(target, thisArg, argumentsList) {
        console.log(target, thisArg, argumentsList);
        if (argumentsList[0] !== 'dom-module') {
          argumentsList[1] = new Proxy(argumentsList[1], {
            construct: function(target, argumentsList, newTarget) {
              console.log('new ' + target.name + '(', argumentsList, ')');
              return new (Function.prototype.bind.apply(target, argumentsList));
            }
          });
        }
        return target.apply(thisArg, argumentsList);
      }
    });
    [ 'Polymer', 'Mixins', 'BaseElements', /* 'Define', */ 'PolymerElements', 'bundles' ].forEach((i) => {
      try {
        window[i] = new Proxy(window[i] || Object.create(null), {
          set: function (target, property, value, receiver) {
            console.log(i + '[' + property + '] = ', value);
            return target[property] = value;
          }
        });
      }
      catch (e) {
        console.log(e);
      }
    });
    // no more global variables and objects
    //Object.freeze(window);
    </script>
    <link rel="import" href="localizable-element.html">
    <link rel="import" href="i18n-subclass-element.html">
    <link rel="import" href="i18n-thin-element.html">
    <link rel="import" href="i18n-legacy-element.html">
  </head>
  <body>
    <h3>i18n-element Proof of Concept Demo</h3>
    <localizable-element id="el1"></localizable-element><br>
    <i18n-subclass-element id="el2"></i18n-subclass-element><br>
    <i18n-thin-element id="el3"></i18n-thin-element><br>
    <i18n-legacy-element id="el4"></i18n-legacy-element>

    <script>
      HTMLImports.whenReady(function () {
        console.log('HTMLImports.whenReady()');
        [ 'el1', 'el2', 'el3' /*, 'el4'*/ ].forEach((id) => {
          document.getElementById(id).lang = 'ja';
        });
      });

      function printPrototype(obj, prefix) {
  prefix = prefix || '';
  var name = obj && obj.constructor && obj.constructor.name ? obj.constructor.name : ''
  if (name === 'Function' && obj.name) {
    name = 'class ' + obj.name;
  }
  var indent = prefix + ':' + name;

  if (obj) {
    /*
    Object.getOwnPropertyNames(obj).forEach(function (key) {
    //for(var key in obj) {
      if(obj.hasOwnProperty(key)) {
        try {
          console.log(indent, key, ": ", obj[key]);
        }
        catch (e) {
          console.log(indent, key, ": ", "Not Accessible", e);
        }
      }
    });
    */
    console.log(indent, Object.getOwnPropertyNames(obj));
  }
  else {
    console.log(indent, ": ", obj);
  }
  
  if(obj) {
    if(Object.getPrototypeOf) {
      printPrototype(Object.getPrototypeOf(obj), indent);
    } else if(obj.__proto__) {
      printPrototype(obj.__proto__, indent);
    }
  }
}

    /*
    get __data() {
      const is = this.is;
      console.log('=========================== get ' + this.is + '.__data', this.___data);
      return this.___data;
    }
    set __data(value) {
      const is = this.is;
      console.log('=========================== set ' + this.is + '.__data = ', value);
      this.___data = new Proxy(value, {
        get: function(target, prop, receiver) {
          console.log('=========================== get ' + is + '.__data.' + prop, target[prop]);
          return target[prop];
        },
        set: function(target, prop, value, receiver) {
          console.log('=========================== set ' + is + '.__data.' + prop + ' = ', value);
          target[prop] = value;
          return true;
        }
      });
    }
    */


    </script>

  </body>
</html>
